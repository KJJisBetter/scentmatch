#!/bin/bash

echo "ðŸš€ Starting End-to-End Frontend Verification"
echo "============================================"

# Check if development server is running
if curl -s http://localhost:3000 > /dev/null 2>&1; then
    echo "âœ… Development server is already running"
    SERVER_WAS_RUNNING=true
else
    echo "ðŸ Starting development server..."
    npm run dev &
    DEV_SERVER_PID=$!
    SERVER_WAS_RUNNING=false
    
    # Wait for server to be ready
    echo "â³ Waiting for server to be ready..."
    for i in {1..30}; do
        if curl -s http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… Server is ready"
            break
        fi
        echo "ðŸ”„ Attempt $i/30 - waiting..."
        sleep 2
    done
    
    if ! curl -s http://localhost:3000 > /dev/null 2>&1; then
        echo "âŒ Server failed to start"
        exit 1
    fi
fi

# Ensure output directory exists
mkdir -p test-results

echo ""
echo "ðŸ§ª Running comprehensive frontend verification tests..."
echo ""

# Run the Playwright tests
npx playwright test tests/qa/end-to-end-verification.test.ts --config=playwright.e2e.config.ts --reporter=html,json,list

TEST_EXIT_CODE=$?

echo ""
echo "ðŸ“Š Generating verification report..."

# Check if we have test results
if [ -f "test-results/results.json" ]; then
    echo "âœ… Test results found"
else
    echo "âš ï¸ Test results not found - generating basic report"
fi

# Create summary report
TIMESTAMP=$(date -Iseconds)
SUMMARY_FILE="test-results/frontend-verification-summary.md"

cat > "$SUMMARY_FILE" << EOF
# Frontend Verification Report

**Date:** $TIMESTAMP
**Environment:** Development  
**Status:** Verification Complete

## Test Execution Summary

- **Test Runner:** Playwright
- **Configuration:** playwright.e2e.config.ts
- **Test File:** tests/qa/end-to-end-verification.test.ts
- **Exit Code:** $TEST_EXIT_CODE

## Reports Available

- **HTML Report:** test-results/html-report/index.html
- **JSON Results:** test-results/results.json (if available)
- **Summary:** test-results/frontend-verification-summary.md

## What Was Verified

### âœ… Complete User Journey Testing
- Home page to dashboard registration flow
- Authentication system integration  
- Protected route access controls
- Session persistence verification

### âœ… Performance Validation
- Core Web Vitals measurement (LCP, INP, CLS)
- Cross-device responsiveness testing
- Database query performance verification
- Error handling and recovery testing

### âœ… Accessibility Compliance  
- WCAG 2.2 AA compliance verification
- Screen reader compatibility
- Keyboard navigation support
- Cross-platform accessibility

### âœ… Integration Testing
- Frontend-backend integration
- Database RLS policy enforcement
- Cross-feature integration verification
- Multi-device compatibility

## Platform Status

$(if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo "**Frontend Verification:** Complete âœ…"
    echo "**Integration Status:** Verified âœ…"
    echo "**Performance Targets:** Met âœ…" 
    echo "**Accessibility Standards:** Compliant âœ…"
    echo ""
    echo "## Recommendation"
    echo ""
    echo "**âœ… PRODUCTION READY:** All critical tests passed successfully."
else
    echo "**Frontend Verification:** Issues Found âš ï¸"
    echo "**Integration Status:** Review Required âš ï¸"
    echo "**Performance Targets:** Check Results âš ï¸"
    echo "**Accessibility Standards:** Review Required âš ï¸"
    echo ""
    echo "## Recommendation"
    echo ""
    echo "**âš ï¸ REVIEW REQUIRED:** Some tests failed. Check detailed results."
fi)

## Next Steps

1. **Review detailed results** in HTML report: test-results/html-report/index.html
2. **Address any failing tests** before production deployment
3. **Set up continuous testing** pipeline for ongoing verification
4. **Monitor Core Web Vitals** in production environment

---

*Generated by ScentMatch Frontend Verification System*
EOF

echo "âœ… Summary report generated: $SUMMARY_FILE"

# Display final results
echo ""
echo "============================================"
echo "ðŸ“‹ FRONTEND VERIFICATION COMPLETE"
echo "============================================"

if [ $TEST_EXIT_CODE -eq 0 ]; then
    echo "ðŸŽ‰ All tests passed successfully!"
    echo "âœ… Platform is ready for production deployment"
else
    echo "âš ï¸ Some tests failed (exit code: $TEST_EXIT_CODE)"
    echo "ðŸ“„ Check detailed results in: test-results/html-report/index.html"
fi

echo ""
echo "ðŸ“„ Reports available:"
echo "   - Summary: $SUMMARY_FILE"
if [ -f "test-results/html-report/index.html" ]; then
    echo "   - HTML Report: test-results/html-report/index.html"
fi
if [ -f "test-results/results.json" ]; then
    echo "   - JSON Results: test-results/results.json"
fi

# Cleanup server if we started it
if [ "$SERVER_WAS_RUNNING" = false ] && [ -n "$DEV_SERVER_PID" ]; then
    echo ""
    echo "ðŸ›‘ Stopping development server..."
    kill $DEV_SERVER_PID 2>/dev/null
    sleep 2
    echo "âœ… Development server stopped"
fi

echo ""
echo "ðŸŽ¯ Frontend verification process complete!"

exit $TEST_EXIT_CODE